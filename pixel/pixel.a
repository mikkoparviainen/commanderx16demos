!to "pixel.prg", cbm

verareg=$9f20
veralo  = verareg+0
veramid = verareg+1
verahi  = verareg+2
veradat = verareg+3
veradat2= verareg+4
veractl = verareg+5
veraien = verareg+6
veraisr = verareg+7

vreg_cmp  = $F0000
vreg_pal  = $F1000
vreg_lay1 = $F2000
vreg_lay2 = $F3000
vreg_spr  = $F4000
vreg_sprd = $F5000

pixlo = $FB
pixmid = pixlo+1
pixhi = pixmid+1

*=$0801
	!byte $0b,$08,$01,$00,$9e,$32,$30,$36,$31,$00,$00,$00

	jsr vera_init ; set 8bpp bitmap mode
	lda #01
	sta colour
	jsr clear_screen

	lda #1
	sta x
	lda #0
	sta y
	lda #00
	sta colour
	jsr draw_pixel

	lda #$FE
	tay
-	tya
	sta x
	sta y
	jsr draw_pixel
	dey
	bne -

	lda #0
	sta veralo
	sta veramid
	lda #$10
	sta verahi ; $00000 - start of graph mem and inc = 1

	lda #00
	tax
	lda #04
-	sta veradat
	dex
	bne -

	lda #$00
	tax
-	dex
	bne -
	jsr text_mode ; set text mode back
	rts

; parameters for the pixel - faster to do it this way
x: !byte $00, $00
y: !byte $00, $00

draw_pixel:
	; assumes that y < 512 x < 512
	lda #$00
	sta pixhi
	sta pixmid
	sta pixlo ; empty working area

	lda y
	sta pixmid
	lda y+1
	sta pixhi ; pixlo-pixmid-pixhi = 256 * y

	lda y
	asl
	asl
	asl
	asl
	asl
	asl
	sta pixlo ; pixlo = 64 * y
	
	lda y
	lsr
	lsr 
	clc
	adc pixmid
	sta pixmid
	lda #0
	adc pixhi
	sta pixhi ; pixmid:pixhi += 64 * y

	lda y+1
	asl
	asl
	asl
	asl
	asl
	asl
	clc
	adc pixmid
	lda #0
	adc pixhi

	; now pixlo:pixmid:pixhi = 320 * y

	lda x
	clc
	adc pixlo
	sta pixlo
	lda #0
	adc pixmid
	sta pixmid
	lda #0
	adc pixhi
	sta pixhi 

	lda x+1
	clc
	adc pixmid
	sta pixmid
	lda #0
	adc pixhi
	sta pixhi ; pixlo:pixmid:pixhi += x

	lda pixlo
	sta veralo
	lda pixmid
	sta veramid
	lda pixhi
	sta verahi ; veralo:veramid:verahi = pos of pixel, inc=0

	lda colour
	sta veradat ; print pixel

	rts

vera_init:
	 lda #$0
	 sta veramid
	 lda #$0F
	 sta verahi ; $F0000 
	 lda #$01
	 sta veralo ; $F0001
	 lda #64 ; HSCALE = 64 -> 2 pixels per write
	 sta veradat
	 lda #$02 ; $F0002
	 sta veralo
	 lda #64 
	 sta veradat ; VSCALE = 64 -> 2 pixels per write

	 lda #$0
	 sta veralo
	 lda #$20
	 sta veramid
	 lda #$0F 
	 sta verahi ; $F2000, increment 0 - layer 0 register 0
	 lda #$E1 ; mode bitmap 8bpp, enabled 
	 sta veradat ; set mode
	 lda #$01 
	 sta veralo ; $F2001
	 lda #$00
	 sta veradat ; TILEW=0  -> 320 px
	 lda #$04
	 sta veralo
	 lda #0
	 sta veradat ; TILEBASE_LO = 0
	 lda #$05
	 sta veralo
	 lda #0
	 sta veradat ; TILEBASE_HI = 0

	 rts

text_mode:
	rts

clear_screen:
	lda #$0
	sta veralo
	sta veramid
	lda #$10
	sta verahi ; $00000, increment 1
	lda #$FF
	tay
--	lda #$F0
	tax
	lda colour
-	sta veradat
	dex
	bne -
	dey
    beq +
    jmp --
+   lda #65
	tay
--	lda #$F0
	tax
	lda colour
-	sta veradat
	dex
	bne -
	dey
    beq +
    jmp --

+	rts

colour: !byte $00